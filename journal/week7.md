# Week 7 â€” Solving CORS with a Load Balancer and Custom Domain
## Fix Messaging in Prod Environment
As both week 6-7 were merged, so it is hard to segregate things between these two weeks. Till now we have created a service for Backend in our ECS cluster and done with the Health-Check. Here we have fixed the Messaging in the Prod Environment and succefully created a Frontend Service in ECS cluster with success health-check status.

Also restructured our bash scripts for `build`, `Tag & Push`, `Force Deploy`, `Connect`.

- **Build Script for Frontend** [code](https://github.com/krunalijain/aws-bootcamp-cruddur-2023/blob/main/bin/frontend/build)
- **Connect Script for Frontend** [code](https://github.com/krunalijain/aws-bootcamp-cruddur-2023/blob/main/bin/frontend/connect)
- **Push Script for Frontend** [code](https://github.com/krunalijain/aws-bootcamp-cruddur-2023/blob/main/bin/frontend/push)
- **Deploy Script for Frontend** [code](https://github.com/krunalijain/aws-bootcamp-cruddur-2023/blob/main/bin/frontend/deploy)

If you come accross and error that says 9 sessions active so for that we had created a script that kills all connections.
```bash
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE 
-- don't kill my own connection!
pid <> pg_backend_pid()
-- don't kill the connections to other databases
AND datname = 'cruddur';
```

## Fargate Configuration
Create `register` script 
For Backend
```bash
#! /usr/bin/bash

ABS_PATH=$(readlink -f "$0")
FRONTEND_PATH=$(dirname $ABS_PATH)
BIN_PATH=$(dirname $FRONTEND_PATH)
PROJECT_PATH=$(dirname $BIN_PATH)
TASK_DEF_PATH="$PROJECT_PATH/aws/task-definitions/backend-flask.json"

echo $TASK_DEF_PATH

aws ecs register-task-definition \
--cli-input-json "file://$TASK_DEF_PATH"
```
For Frontend
```bash
#! /usr/bin/bash

ABS_PATH=$(readlink -f "$0")
BACKEND_PATH=$(dirname $ABS_PATH)
BIN_PATH=$(dirname $BACKEND_PATH)
PROJECT_PATH=$(dirname $BIN_PATH)
TASK_DEF_PATH="$PROJECT_PATH/aws/task-definitions/frontend-react-js.json"

echo $TASK_DEF_PATH

aws ecs register-task-definition \
--cli-input-json "file://$TASK_DEF_PATH"
```

## Domain
My domain was purchased from Godaddy.com and had to be converted to Route 53. So I first created host in ROute 53 and then took those nameservers and replaced in Godaddy.com . So now there will be no records maintained as the records are transfered to Route 53.
I referred [this youtube video](https://youtu.be/RI8oy-HGkIQ) for changing the nameservers and connecting Godaddy domain to Route 53.
I used wildcard for the sub domain (api). For eg: If your domain is `exapmle.com` then by using wildcard record I created `api.exapmle.com`.
Both had an SSL Certificate generated by ACM (Amazon Certificate Manager). 

## Generated env vars scripts using Ruby
For Frontend 
```ruby
#!/usr/bin/env ruby

require 'erb'

template = File.read 'erb/frontend-react-js.env.erb'
content = ERB.new(template).result(binding)
filename = "frontend-react-js.env"
File.write(filename, content)
```
For Backend
```ruby
#!/usr/bin/env ruby

require 'erb'

template = File.read 'erb/backend-flask.env.erb'
content = ERB.new(template).result(binding)
filename = "backend-flask.env"
File.write(filename, content)
```
## To create network using docker
```
docker network create cruddur-net
```

**Created `Dockerfile.prod` for Production Environment**
```
FROM accountID.dkr.ecr.us-east-1.amazonaws.com/cruddur-python:3.10-slim-buster

# [TODO] For debugging, don't leave these in
#RUN apt-get update -y
#RUN apt-get install iputils-ping -y
# -----

# Inside Contain
# Inside Container
# make a new folder inside container
WORKDIR /backend-flask

# Outside Container -> Inside Container
# this contains the libraries want to install to run the app
COPY requirements.txt requirements.txt

# Inside Container
# Install the python libraries used for the app
RUN pip3 install -r requirements.txt

# Outside Container -> Inside Container
# . means everything in the current directory
# first period . - /backend-flask (outside container)
# second period . /backend-flask (inside container)
COPY . .

EXPOSE ${PORT}

# CMD (Command)
# python3 -m flask run --host=0.0.0.0 --port=4567
CMD [ "python3", "-m" , "flask", "run", "--host=0.0.0.0", "--port=4567", "--no-debug","--no-debugger","--no-reload"]
```

So after doing all this stuff I was abe to load my cruddur web app from my Domain and was able to message in a message group. 
![](https://user-images.githubusercontent.com/115455157/232265996-a4c2c205-2a7b-4fff-8617-f6c469b92eb2.jpg)
)


